# ğŸ”’ Trust Proxy å®‰å…¨é…ç½®ä¿®å¤

## âŒ é”™è¯¯ä¿¡æ¯

```
ValidationError: The Express 'trust proxy' setting is true, which allows anyone to trivially bypass IP-based rate limiting.
```

## ğŸ” é—®é¢˜è¯´æ˜

è¿™æ˜¯ä¸€ä¸ª**å®‰å…¨è­¦å‘Š**ï¼Œè¡¨ç¤ºå½“å‰çš„ `trust proxy` é…ç½®å­˜åœ¨å®‰å…¨é£é™©ï¼š

### é—®é¢˜åŸå› 

- `trust proxy: true` ä¼šä¿¡ä»»**æ‰€æœ‰**ä»£ç†æœåŠ¡å™¨
- æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¼ªé€  `X-Forwarded-For` å¤´æ¥ç»•è¿‡åŸºäº IP çš„é€Ÿç‡é™åˆ¶
- è¿™ä¼šå¯¼è‡´é€Ÿç‡é™åˆ¶å¤±æ•ˆï¼Œæ— æ³•æœ‰æ•ˆé˜²æ­¢æ¶æ„è¯·æ±‚

### ä¸ºä»€ä¹ˆéœ€è¦ä¿®å¤

1. **å®‰å…¨é£é™©**ï¼šå…è®¸æ”»å‡»è€…ç»•è¿‡é€Ÿç‡é™åˆ¶
2. **æ€§èƒ½å½±å“**ï¼šæ— æ³•æœ‰æ•ˆé™åˆ¶æ¶æ„è¯·æ±‚ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨è¿‡è½½
3. **åˆè§„è¦æ±‚**ï¼šç”Ÿäº§ç¯å¢ƒåº”è¯¥éµå¾ªå®‰å…¨æœ€ä½³å®è·µ

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤å†…å®¹

å·²å°† `trust proxy: true` æ”¹ä¸º `trust proxy: 1`ï¼š

```javascript
// ä¿®å¤å‰ï¼ˆä¸å®‰å…¨ï¼‰
app.set('trust proxy', true);

// ä¿®å¤åï¼ˆå®‰å…¨ï¼‰
app.set('trust proxy', 1);  // åªä¿¡ä»»ç¬¬ä¸€ä¸ªä»£ç†ï¼ˆNginxï¼‰
```

### é…ç½®è¯´æ˜

- **`trust proxy: 1`**ï¼šåªä¿¡ä»»ç¬¬ä¸€ä¸ªä»£ç†æœåŠ¡å™¨ï¼ˆå³ Nginxï¼‰
- **`trust proxy: true`**ï¼šä¿¡ä»»æ‰€æœ‰ä»£ç†æœåŠ¡å™¨ï¼ˆä¸å®‰å…¨ï¼‰
- **`trust proxy: false`**ï¼šä¸ä¿¡ä»»ä»»ä½•ä»£ç†ï¼ˆä¸é€‚ç”¨äºåå‘ä»£ç†åœºæ™¯ï¼‰

### å·¥ä½œåŸç†

1. **Nginx è®¾ç½®**ï¼šNginx åœ¨è½¬å‘è¯·æ±‚æ—¶ä¼šè®¾ç½® `X-Forwarded-For` å’Œ `X-Real-IP` å¤´
2. **Express è¯»å–**ï¼šExpress é€šè¿‡ `trust proxy: 1` åªä¿¡ä»»ç¬¬ä¸€ä¸ªä»£ç†ï¼ˆNginxï¼‰è®¾ç½®çš„ IP
3. **é€Ÿç‡é™åˆ¶**ï¼š`express-rate-limit` ä½¿ç”¨ `req.ip` è·å–çœŸå®å®¢æˆ·ç«¯ IP è¿›è¡Œé™åˆ¶

## ğŸ”§ éªŒè¯ä¿®å¤

### 1. é‡å¯æœåŠ¡

```bash
pm2 restart edupro-backend
pm2 logs edupro-backend --lines 20
```

### 2. æ£€æŸ¥æ—¥å¿—

å¯åŠ¨åï¼Œ**ä¸åº”è¯¥**å†çœ‹åˆ° `ERR_ERL_PERMISSIVE_TRUST_PROXY` é”™è¯¯ã€‚

### 3. æµ‹è¯•é€Ÿç‡é™åˆ¶

```bash
# å¿«é€Ÿå‘é€å¤šä¸ªè¯·æ±‚ï¼Œæµ‹è¯•é€Ÿç‡é™åˆ¶æ˜¯å¦ç”Ÿæ•ˆ
for i in {1..110}; do
  curl -I https://edupro.qingsongkao.cn/api/config/subjects
done

# åº”è¯¥åœ¨ç¬¬ 100 ä¸ªè¯·æ±‚åå¼€å§‹è¿”å› 429 Too Many Requests
```

## ğŸ“ å…¶ä»– Trust Proxy é€‰é¡¹

å¦‚æœéœ€è¦æ›´ç²¾ç»†çš„æ§åˆ¶ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹é€‰é¡¹ï¼š

### é€‰é¡¹ 1: ä¿¡ä»»ç‰¹å®š IP åœ°å€

```javascript
// åªä¿¡ä»»æœ¬åœ° Nginx
app.set('trust proxy', '127.0.0.1');
```

### é€‰é¡¹ 2: ä¿¡ä»»æœ¬åœ°å›ç¯åœ°å€

```javascript
// ä¿¡ä»»æ‰€æœ‰æœ¬åœ°å›ç¯åœ°å€
app.set('trust proxy', 'loopback');
```

### é€‰é¡¹ 3: ä¿¡ä»»ç‰¹å®šå­ç½‘

```javascript
// ä¿¡ä»» 10.0.0.0/8 å­ç½‘
app.set('trust proxy', '10.0.0.0/8');
```

### é€‰é¡¹ 4: è‡ªå®šä¹‰å‡½æ•°

```javascript
app.set('trust proxy', (ip) => {
  // åªä¿¡ä»»æœ¬åœ° IP
  return ip === '127.0.0.1' || ip === '::1';
});
```

## ğŸ” å®‰å…¨æœ€ä½³å®è·µ

### 1. æœ€å°æƒé™åŸåˆ™

åªä¿¡ä»»å¿…è¦çš„ä»£ç†æœåŠ¡å™¨ï¼Œä¸è¦ä½¿ç”¨ `trust proxy: true`ã€‚

### 2. éªŒè¯ä»£ç†æ¥æº

ç¡®ä¿åªæœ‰å—ä¿¡ä»»çš„ä»£ç†ï¼ˆå¦‚ Nginxï¼‰å¯ä»¥è®¾ç½® `X-Forwarded-For` å¤´ã€‚

### 3. Nginx é…ç½®

ç¡®ä¿ Nginx æ­£ç¡®è®¾ç½®ä»£ç†å¤´ï¼š

```nginx
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Forwarded-Proto $scheme;
```

### 4. é€Ÿç‡é™åˆ¶é…ç½®

ä½¿ç”¨æ ‡å‡†åŒ–çš„é€Ÿç‡é™åˆ¶å¤´éƒ¨ï¼š

```javascript
const limiter = rateLimit({
  standardHeaders: true,  // ä½¿ç”¨æ ‡å‡†å¤´éƒ¨
  legacyHeaders: false     // ä¸ä½¿ç”¨æ—§ç‰ˆå¤´éƒ¨
});
```

## âœ… ä¿®å¤éªŒè¯æ¸…å•

- [ ] ä»£ç å·²æ›´æ–°ï¼š`trust proxy: 1`
- [ ] æœåŠ¡å·²é‡å¯
- [ ] é”™è¯¯æ—¥å¿—å·²æ¶ˆå¤±
- [ ] é€Ÿç‡é™åˆ¶æ­£å¸¸å·¥ä½œ
- [ ] API è¯·æ±‚æ­£å¸¸å“åº”

## ğŸ“ ç›¸å…³èµ„æº

- [Express Trust Proxy æ–‡æ¡£](https://expressjs.com/en/guide/behind-proxies.html)
- [express-rate-limit æ–‡æ¡£](https://github.com/express-rate-limit/express-rate-limit)
- [å®‰å…¨è­¦å‘Šè¯´æ˜](https://express-rate-limit.github.io/ERR_ERL_PERMISSIVE_TRUST_PROXY/)

## ğŸ¯ æ€»ç»“

**è¿™æ˜¯ä¸€ä¸ªé‡è¦çš„å®‰å…¨ä¿®å¤**ï¼Œåº”è¯¥ç«‹å³åº”ç”¨ï¼š

1. âœ… æé«˜å®‰å…¨æ€§ï¼šé˜²æ­¢ç»•è¿‡é€Ÿç‡é™åˆ¶
2. âœ… ç¬¦åˆæœ€ä½³å®è·µï¼šåªä¿¡ä»»å¿…è¦çš„ä»£ç†
3. âœ… ä¸å½±å“åŠŸèƒ½ï¼šä»ç„¶å¯ä»¥æ­£ç¡®è·å–å®¢æˆ·ç«¯ IP
4. âœ… æ¶ˆé™¤è­¦å‘Šï¼šä¸å†æ˜¾ç¤ºå®‰å…¨è­¦å‘Š

ä¿®å¤åï¼Œåº”ç”¨å°†æ›´åŠ å®‰å…¨ï¼Œé€Ÿç‡é™åˆ¶ä¹Ÿèƒ½æ­£å¸¸å·¥ä½œã€‚

